---
import PlotFigure from './PlotFigure.astro';
import aplCommunes from '../assets/apl_communes (1).json';
import demographie from '../assets/demographie_dep (1).json';

// PrÃ©parer les donnÃ©es APL par dÃ©partement
const aplData = aplCommunes
  .filter((d: any) => d.annee === 2023)
  .reduce((acc: any, d: any) => {
    const dept = String(d.code_dept).padStart(2, '0');
    if (!acc[dept]) acc[dept] = [];
    acc[dept].push(+d.apl_total);
    return acc;
  }, {});

const aplMedian = Object.entries(aplData).map(([code_dept, values]: [string, any]) => ({
  code_dept,
  apl_median: values.sort((a: number, b: number) => a - b)[Math.floor(values.length / 2)]
}));

// Croiser avec dÃ©mographie
const scatterData = demographie
  .map((d: any) => {
    const apl = aplMedian.find(a => a.code_dept === String(d.code_dept).padStart(2, '0'));
    return {
      code_dept: d.code_dept,
      pct65: d.pct65,
      apl_median: apl ? apl.apl_median : null
    };
  })
  .filter((d: any) => d.pct65 != null && d.apl_median != null);
---

<PlotFigure 
  title="Double vulnÃ©rabilitÃ© : APL MG vs % de 65 ans et +"
  description="Chaque point = un dÃ©partement. Bas-gauche = prioritÃ© (APL faible + pop. Ã¢gÃ©e)"
>
  <div id="scatter-double-vulnerabilite"></div>
</PlotFigure>

<script type="module" define:vars={{ scatterData }}>
  import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";

  const chart = Plot.plot({
    width: 900,
    height: 600,
    marginLeft: 60,
    marginBottom: 50,
    x: {
      label: "APL MG mÃ©diane â†’ Plus bas = AccÃ¨s plus difficile",
      grid: true,
      nice: true
    },
    y: {
      label: "% de 65 ans et + â†’ Plus haut = Population plus Ã¢gÃ©e",
      grid: true,
      tickFormat: d => `${(d * 100).toFixed(0)}%`,
      nice: true
    },
    color: {
      type: "categorical",
      domain: ["DÃ©partement", "Tendance"],
      range: ["#3b82f6", "#ef4444"]
    },
    marks: [
      Plot.dot(scatterData, {
        x: "apl_median",
        y: "pct65",
        r: 6,
        fill: "#3b82f6",
        opacity: 0.7,
        stroke: "#1e40af",
        strokeWidth: 1,
        title: d => `DÃ©partement ${d.code_dept}\nAPL MG: ${d.apl_median.toFixed(1)}\n65+ : ${(d.pct65 * 100).toFixed(1)}%\n${d.apl_median < 3 && d.pct65 > 0.23 ? 'ðŸ”´ PRIORITÃ‰: Double vulnÃ©rabilitÃ©' : d.apl_median < 4 ? 'ðŸŸ  Attention: AccÃ¨s limitÃ©' : 'ðŸŸ¢ Situation correcte'}`
      }),
      Plot.linearRegressionY(scatterData, {
        x: "apl_median",
        y: "pct65",
        stroke: "#ef4444",
        strokeWidth: 2.5,
        strokeDasharray: "5,5",
        opacity: 0.8
      }),
      // Lignes de rÃ©fÃ©rence
      Plot.ruleX([3], { stroke: "#f59e0b", strokeWidth: 1, strokeDasharray: "3,3", opacity: 0.5 }),
      Plot.ruleY([0.23], { stroke: "#f59e0b", strokeWidth: 1, strokeDasharray: "3,3", opacity: 0.5 })
    ]
  });

  document.getElementById('scatter-double-vulnerabilite').appendChild(chart);
</script>
