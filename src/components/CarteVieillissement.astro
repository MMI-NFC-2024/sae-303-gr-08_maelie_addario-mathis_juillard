---
import PlotFigure from './PlotFigure.astro';
import { readFile } from 'fs/promises';
import { join } from 'path';

// Import des donnÃ©es dÃ©mographiques
import demographie from '../assets/demographie_dep (1).json';

// Charger le GeoJSON depuis le dossier public
const geoJsonPath = join(process.cwd(), 'public/departements.geojson');
const departementsGeoJSON = JSON.parse(await readFile(geoJsonPath, 'utf-8'));

// Enrichir le GeoJSON avec les donnÃ©es dÃ©mographiques
const enrichedFeatures = departementsGeoJSON.features.map((f: any) => {
  const code = String(f.properties.code_dept || f.properties.code_insee || f.properties.code || '').padStart(2, '0');
  const demo = demographie.find((d: any) => String(d.code_dept).padStart(2, '0') === code);
  return {
    type: 'Feature',
    geometry: f.geometry,
    properties: {
      ...f.properties,
      code_dept: code,
      nom: f.properties.nom || f.properties.name || code,
      pct65: demo ? demo.pct65 : null
    }
  };
});

const geoData = {
  type: 'FeatureCollection',
  features: enrichedFeatures
};
---

<PlotFigure 
  title="Part des 65 ans et + par dÃ©partement"
  description="Plus la couleur est intense, plus la part des personnes Ã¢gÃ©es est Ã©levÃ©e."
>
  <div id="carte-vieillissement"></div>
</PlotFigure>

<script type="module" define:vars={{ geoData }}>
  import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";

  const chart = Plot.plot({
    width: 1100,
    height: 900,
    projection: {
      type: "mercator",
      domain: geoData
    },
    color: {
      type: "quantile",
      n: 8,
      scheme: "blues",
      legend: true,
      label: "% de 65 ans et + â†’ Plus foncÃ© = Population plus Ã¢gÃ©e",
      tickFormat: d => `${(d * 100).toFixed(0)}%`
    },
    marks: [
      Plot.geo(geoData.features, {
        fill: d => d.properties.pct65,
        stroke: "#333",
        strokeWidth: 0.8,
        title: d => `${d.properties.nom}\n65 ans et + : ${d.properties.pct65 ? (d.properties.pct65 * 100).toFixed(1) + '%' : 'DonnÃ©es non disponibles'}\n${d.properties.pct65 > 0.25 ? 'ðŸ‘´ Population trÃ¨s Ã¢gÃ©e' : d.properties.pct65 > 0.20 ? 'â†’ Vieillissement modÃ©rÃ©' : 'ðŸ‘¨ Population jeune'}`
      })
    ]
  });

  document.getElementById('carte-vieillissement').appendChild(chart);
</script>
